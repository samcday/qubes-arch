# Maintainer: Sam Day <me@samcday.com>
pkgname=qubes-db
pkgver=4.1.8
pkgrel=1
pkgdesc="Qubes component: core-qubesdb"
arch=(x86_64)
url="https://github.com/QubesOS/qubes-core-qubesdb"
license=(GPL)
depends=(libvchan-xen)
makedepends=(git python)
install=qubes-db.install

source=(
  "git+https://github.com/qubesos/qubes-core-qubesdb?tag=v${pkgver}"
  allpatches
  )
sha512sums=('SKIP'
            '005e70d92ddef0ad3f96ffe35c80d6b97bfd3df1baff224ac2b2960d1b9d756dfd02ff0a9895656d68fb2834667bf4e26932d6400faf9407e1b64236d64a8f19')

prepare() {
  {
    set -uex -o pipefail
    patch -p2 -d ${srcdir} < allpatches
  }
}

build() {
  make -C ${srcdir}/qubes-core-qubesdb BACKEND_VMM=xen prefix=/usr all
}

package() {
  for dir in include python client daemon; do
    make -C ${srcdir}/qubes-core-qubesdb/${dir} DESTDIR="$pkgdir/" SBINDIR=/usr/bin LIBDIR=/usr/lib install
  done

  install -D -m 0644 "${srcdir}/qubes-core-qubesdb/daemon/qubes-db.service" "${pkgdir}/usr/lib/systemd/system/qubes-db.service"
  install -D -m 0644 "${srcdir}/qubes-core-qubesdb/daemon/qubes-db.socket" "${pkgdir}/usr/lib/systemd/system/qubes-db.socket"
}
