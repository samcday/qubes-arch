# Maintainer: Sam Day <me@samcday.com>
pkgname=(qrexec qrexec-dom0 qrexec-vm)
pkgbase=qrexec
pkgver=mm_68b8b65f
pkgrel=1
pkgdesc="qrexec, the Qubes OS Remote Procedure Call (RPC) protocol."
arch=(x86_64)
url="https://github.com/QubesOS/qubes-core-qrexec"
license=('GPL')
depends=(libvchan-xen python python-gbulb)
makedepends=(
  git
  pandoc
  python-asynctest
  python-coverage
  python-dbus
  python-psutil
  python-pyinotify
  python-pytest
  python-recommonmark
  python-sphinx
  python-systemd
  )
source=(
  "git+https://github.com/qubesos/qubes-core-qrexec?tag=v${pkgver}"
  0001-Change-install-targets-to-use-BINDIR-SBINDIR-LIBDIR.patch
  0002-qrexec-policy-daemon-systemd-improvements.patch
  )
sha512sums=('SKIP'
            'd12ffc9be227cf76ae4bebfc6d6019392b0f0ab0d9f16995d10b5ad9e2b686a600b25c305c3d3c2fc069fba4645327bbc7e1b58dc404a8a683d26de6bf12fdaa'
            'c29e18e6616742614499676fbbf7c0ef39f31243a9ba9194fbbe273dc01980bf84500fe777afd3c9e72345a6f006c83a77913953f2abe9aa35556d6bf8296a02')

prepare() {
  git -C ${srcdir}/qubes-core-qrexec am ${srcdir}/*.patch
}

build() {
  BACKEND_VMM=xen make -C "${srcdir}/qubes-core-qrexec" prefix=/usr all
}

check() {
  # Disabled atm, qrexec/tests/socket/daemon.py::TestDaemon::test_client_exec hangs.
  # if pkg-config vchan-socket; then
  if false; then
    echo "libvchan-socket is available, including socket tests"
    cp -R "qubes-core-qrexec" "qubes-core-qrexec-socket"
    cd qubes-core-qrexec-socket

    export CFLAGS="--coverage -DCOVERAGE"
    export LDFLAGS=--coverage
    make -C libqrexec BACKEND_VMM=socket
    make -C agent BACKEND_VMM=socket
    make -C daemon BACKEND_VMM=socket
  else
    echo "libvchan-socket not available, skipping socket tests"
    cd qubes-core-qrexec
    export SKIP_SOCKET_TESTS=1
  fi

  python3 -m coverage run -m pytest qrexec/tests -o python_files=*.py -v "$@"
}

package_qrexec() {
  make -C "${srcdir}/qubes-core-qrexec" DESTDIR="$pkgdir/" install-base
}

package_qrexec-dom0() {
  depends+=(qrexec qubes-dom0)
  conflicts+=(qrexec-vm)
  install=qrexec-dom0.install

  make -C "${srcdir}/qubes-core-qrexec" DESTDIR="$pkgdir/" LIBDIR=/usr/lib SBINDIR=/usr/bin install-dom0
}

package_qrexec-vm() {
	depends+=(qrexec)
	conflicts+=(qrexec-dom0)

  make -C qubes-core-qrexec DESTDIR="$pkgdir/" install-vm
}
