From 673685cda6f664754114b5522c902dfbd881d95c Mon Sep 17 00:00:00 2001
From: Sam Day <me@samcday.com>
Date: Sun, 27 Sep 2020 08:55:49 +0200
Subject: [PATCH] template tmpfiles-qubes.conf to make /var/run dir
 overridable.

---
 linux/system-config/Makefile               | 8 ++++++--
 linux/system-config/tmpfiles-qubes.conf.in | 4 ++++
 2 files changed, 10 insertions(+), 2 deletions(-)
 create mode 100644 linux/system-config/tmpfiles-qubes.conf.in

diff --git a/linux/system-config/Makefile b/linux/system-config/Makefile
index 865880f4..5280fb0d 100644
--- a/linux/system-config/Makefile
+++ b/linux/system-config/Makefile
@@ -1,12 +1,16 @@
+STATEDIR ?= /var/run
+
 all:
 	true
 
-install:
+tmpfiles-qubes.conf: tmpfiles-qubes.conf.in
+	cat tmpfiles-qubes.conf.in | sed "s#@STATEDIR@#$(STATEDIR)#" > tmpfiles-qubes.conf
+install: tmpfiles-qubes.conf
 	mkdir -p $(DESTDIR)/etc/xen/scripts
 	cp vif-route-qubes $(DESTDIR)/etc/xen/scripts
 	cp block-snapshot $(DESTDIR)/etc/xen/scripts
 	ln -s block-snapshot $(DESTDIR)/etc/xen/scripts/block-origin
-	install -m 0644 -D tmpfiles-qubes.conf $(DESTDIR)/usr/lib/tmpfiles.d/qubes.conf
+	install -m 0644 -D tmpfiles-qubes.conf $(DESTDIR)$(LIBDIR)/tmpfiles.d/qubes.conf
 	install -d $(DESTDIR)/etc/logrotate.d
 	install -m 0644 logrotate-qubes \
 		$(DESTDIR)/etc/logrotate.d/qubes
diff --git a/linux/system-config/tmpfiles-qubes.conf.in b/linux/system-config/tmpfiles-qubes.conf.in
new file mode 100644
index 00000000..6e9de85f
--- /dev/null
+++ b/linux/system-config/tmpfiles-qubes.conf.in
@@ -0,0 +1,4 @@
+d @STATEDIR@/qubes 2770 root qubes
+f @STATEDIR@/qubes/xl-lock 0660 root qubes
+f @STATEDIR@/qubes/empty 0444 root qubes
+d @STATEDIR@/xen-hotplug 0755 root root
-- 
2.28.0

